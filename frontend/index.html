<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>

    <link
      rel="stylesheet"
      href="https://cdn3.devexpress.com/jslib/23.1.4/css/dx.light.css"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn3.devexpress.com/jslib/23.1.4/js/dx.all.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f5f5f5;
      }

      #gridContainer {
        width: 60%;
        margin-top: 20px;
        background-color: white;
        padding: 20px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      }

      .delete-button {
        color: #fff;
        background-color: #d9534f;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
      }

      .delete-button:hover {
        background-color: #c9302c;
      }
    </style>
  </head>
  <body>
    <div id="gridContainer"></div>

    <script>
      function createDeleteButton(options, dataSource, grid) {
        return $("<button>")
          .addClass("delete-button")
          .text("Delete")
          .on("click", function () {
            const shouldDelete = confirm(
              `Are you sure you want to delete ${options.data.first_name} ${options.data.last_name}?`
            );
            if (shouldDelete) {
              dataSource
                .store()
                .remove(options.data)
                .then(() => grid.refresh())
                .catch((error) => alert("Delete failed: " + error));
            }
          });
      }

      $(function () {
        let dataSource = new DevExpress.data.DataSource({
          load: function () {
            return sendRequest("/users", "GET", null);
          },
          insert: function (values) {
            return sendRequest(`/users`, "POST", {
              first_name: values.first_name,
              last_name: values.last_name,
              email: values.email,
              telephone: values.telephone,
            });
          },
          update: function (key, values) {
            return sendRequest(`/users/${key.id}`, "PUT", values);
          },
          remove: function (key) {
            return sendRequest(`/users/${key.id}`, "DELETE", null);
          },
        });

        async function sendRequest(url, method = "GET", data) {
          const options = {
            method,
            headers: {
              "Content-Type": "application/json",
            },
            body:
              method !== "GET" && method !== "DELETE"
                ? JSON.stringify(data)
                : null,
          };

          const response = await fetch(`http://localhost:3000${url}`, options);
          return response.json();
        }

        const grid = $("#gridContainer")
          .dxDataGrid({
            dataSource: dataSource,
            columns: [
              {
                dataField: "id",
                caption: "ID",
                allowEditing: false,
                dataType: "string",
                width: "30%",
                alignment: "center",
              },
              {
                dataField: "first_name",
                caption: "First name",
                validationRules: [
                  { type: "required", message: "First name is required" },
                ],
                width: "15%",
                alignment: "center",
              },
              {
                dataField: "last_name",
                caption: "Last name",
                validationRules: [
                  { type: "required", message: "Last name is required" },
                ],
                width: "15%",
                alignment: "center",
              },
              {
                dataField: "email",
                caption: "Email",
                validationRules: [
                  { type: "required", message: "Email is required" },
                  { type: "email", message: "Email is invalid" },
                ],
                width: "20%",
                alignment: "center",
              },
              {
                dataField: "telephone",
                caption: "Telephone",
                validationRules: [
                  { type: "required", message: "Telephone is required." },
                ],
                width: "15%",
                alignment: "center",
              },
              {
                caption: "Actions",
                cellTemplate: function (container, options) {
                  const button = createDeleteButton(options, dataSource, grid);
                  container.append(button);
                },
                width: 100,
                alignment: "center",
              },
            ],
            repaintChangesOnly: true,
            showBorders: true,
            editing: {
              refreshMode: "reshape",
              mode: "cell",
              allowAdding: true,
              allowUpdating: true,
              allowDeleting: false,
            },
            paging: {
              pageSize: 5,
            },
            pager: {
              showPageSizeSelector: true,
              allowedPageSizes: [5, 10, 20],
              showInfo: true,
              showNavigationButtons: true,
            },
            scrolling: {
              mode: "standard",
            },
            filterRow: { visible: true },
            searchPanel: {
              visible: true,
              highlightSearchText: true,
              placeholder: "Search by name or email...",
            },
            headerFilter: { visible: true },
            onRowUpdated: function (e) {
              grid.refresh();
            },
            onRowInserted: function (e) {
              grid.refresh();
            },
            onRowRemoved: function (e) {
              grid.refresh();
            },
          })
          .dxDataGrid("instance");
      });
    </script>
  </body>
</html>
